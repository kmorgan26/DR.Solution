@namespace DRApplication.Client.Controls

@inject IPlatformService PlatformService
@inject DeviceManager DeviceManager

<MudGrid Spacing="2" Justify="Justify.Center">
    @if (Devices is not null)
    {
        @foreach (var item in Devices)
        {
            <DeviceCard DeviceVm="item"></DeviceCard>
        }
    }
</MudGrid>

@code {

    [CascadingParameter]
    public AppStateComponent AppState { get; set; }

    [Parameter]
    public int DeviceTypeId { get; set; }

    IEnumerable<DeviceVm>? Devices;

    protected override async Task OnInitializedAsync()
    {
        if(DeviceManager is not null)
        {
            var filterProperty = new FilterProperty() {  Name ="DeviceTypeId", Operator=FilterQueryOperator.Equals, Value=DeviceTypeId.ToString() };
            
            var filter = new QueryFilter<Device>();

            filter.PaginationFilter = null;
            filter.FilterProperties.Add(filterProperty);

            var response = await DeviceManager.GetAsync(filter);
            var items = response.Data;
            Devices = Mapping.Mapper.Map<IEnumerable<DeviceVm>>(items);

            //TODO: Maybe do this with more grace
            GenericListVm listVm = new() { Id = DeviceTypeId };
            AppState.DeviceTypeVm = await PlatformService.GetDeviceTypeVmFromGenericVm(listVm);
            
        }
    }
}
