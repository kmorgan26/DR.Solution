@namespace DRApplication.Client.Controls.Platforms
@inject DeviceManager _db
@inject IPlatformService PlatformService
@inject ISnackbar Snackbar

<NewButton Url="/device/create" />

@if (!_isBusy)
{
    <MudTable @ref="@_table" Items="@_deviceVms"
          CurrentPage="@_pagedResponse.PageNumber"
          RowsPerPage="@_pagedResponse.PageSize"
          Hover="true"
          Breakpoint="Breakpoint.Sm"
          Striped="true"
          Dense="true"
          Elevation="3"
          RowEditCommit="UpdateRowItem"
          CommitEditIcon="@Icons.Filled.Save"
          OnCommitEditClick="@(() => Snackbar.Add("Row was updated", Severity.Success))"
          TotalItems="@_pagedResponse.TotalRecords">

        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Device</MudTh>
            <MudTh>Device Type</MudTh>
            <MudTh>Active?</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="ID">@context.Id </MudTd>
            <MudTd DataLabel="Device">@context.Device</MudTd>
            <MudTd DataLabel="Platform">@context.Platform</MudTd>
            <MudTd DataLabel="Active?">@context.IsActive</MudTd>
        </RowTemplate>

        <RowEditingTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Platform">
                <MudTextField Variant="Variant.Outlined" @bind-Value="@context.Device" />
            </MudTd>
            <MudTd DataLabel="Platform">
                <MudSelect Variant="Variant.Outlined" Label="Platform" @bind-Value="@context.DeviceTypeId" Text="@context.Platform">
                    @foreach (var deviceType in _deviceTypeVms)
                    {
                        <MudSelectItem Value="@deviceType.Id">@deviceType.Platform</MudSelectItem>
                    }
                </MudSelect>
            </MudTd>
            <MudTd>
                <MudCheckBox @bind-Checked="@context.IsActive" />
            </MudTd>
        </RowEditingTemplate>

        <PagerContent>
            <MudPagination Rectangular="true" SelectedChanged="PageChanged" Color="Color.Primary" Count="_pagedResponse.TotalPages" />
            Showing Page @_pagedResponse.PageNumber of @_pagedResponse.TotalPages
            Total Records: @_pagedResponse.TotalRecords
        </PagerContent>
    </MudTable>
}



@code {
    private MudTable<DeviceVm> _table;
    private bool _isBusy;
    private IEnumerable<DeviceVm> _deviceVms;
    private List<DeviceTypeVm> _deviceTypeVms = new();

    private PagedResponse<Device> _pagedResponse = new();
    private PaginationFilter _paginationFilter = new();
    
    private async void UpdateRowItem(object e)
    {
        var viewModel = (DeviceVm)e;
        var model = Mapping.Mapper.Map<Device>(viewModel);
        await _db.UpdateAsync(model);
        await LoadData();
    }

    private async void PageChanged(int i)
    {
        if (_pagedResponse is not null)
        {
            _paginationFilter.PageNumber = i;
            await LoadData();
        }
    }

    protected async Task LoadData()
    {
        var queryFilter = new QueryFilter<Device>();
        queryFilter.PaginationFilter = _paginationFilter;

        _pagedResponse = await _db.GetAsync(queryFilter);

        var data = _pagedResponse.Data;
        _deviceVms = await PlatformService.GetDeviceVmsFromDeviceListAsync(data);
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        _isBusy = true;

        await LoadData();
        var list = await PlatformService.GetDeviceTypeVmsAsync();
        _deviceTypeVms = list.ToList();

        _isBusy = false;
    }
}
