@namespace DRApplication.Client.Controls.Platforms
@inject DeviceManager manager
@inject IPlatformService PlatformService

<NewButton Url="/device/create" />

@if (!_isBusy)
{
    <MudTable @ref="@_table" Items="@_deviceVms"
          CurrentPage="@_pagedResponse.PageNumber"
          RowsPerPage="@_pagedResponse.PageSize"
          Hover="true"
          Breakpoint="Breakpoint.Sm"
          Striped="true"
          Dense="true"
          Elevation="3"
          TotalItems="@_pagedResponse.TotalRecords">

        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Device</MudTh>
            <MudTh>Device Type</MudTh>
            <MudTh>Active?</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="ID">@context.Id </MudTd>
            <MudTd DataLabel="Device">@context.Device</MudTd>
            <MudTd DataLabel="Platform">@context.Platform</MudTd>
            <MudTd DataLabel="Active?">@context.IsActive</MudTd>
        </RowTemplate>

        <RowEditingTemplate>

        </RowEditingTemplate>

        <PagerContent>
            <MudPagination Rectangular="true" SelectedChanged="PageChanged" Color="Color.Primary" Count="_pagedResponse.TotalPages" />
            Showing Page @_pagedResponse.PageNumber of @_pagedResponse.TotalPages
            Total Records: @_pagedResponse.TotalRecords
        </PagerContent>

    </MudTable>
}
@code {
    private MudTable<DeviceVm> _table;
    private bool _isBusy;
    private IEnumerable<DeviceVm> _deviceVms;

    private PagedResponse<Device> _pagedResponse = new();
    private PaginationFilter _paginationFilter = new();

    private async Task UpdateRowItem(object e)
    {
        var viewModel = (DeviceVm)e;
        var model = Mapping.Mapper.Map<Device>(viewModel);
        await manager.UpdateAsync(model);
    }

    private async void PageChanged(int i)
    {
        if (_pagedResponse is not null)
        {
            _paginationFilter.PageNumber = i;
            await LoadData();
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    private async Task LoadData()
    {
        _isBusy = true;
        //var queryFilter = new QueryFilter<Device>();
        //queryFilter.PaginationFilter = _paginationFilter;

        //_pagedResponse = await manager.GetAsync(queryFilter);
        //_deviceVms = Mapping.Mapper.Map<List<DeviceVm>>(_pagedResponse.Data);
        //StateHasChanged();
        //_isBusy = true;

        var queryFilter = new QueryFilter<Device>();
        queryFilter.PaginationFilter = _paginationFilter;

        _pagedResponse = await manager.GetAsync(queryFilter);

        var data = _pagedResponse.Data;
        _deviceVms = await PlatformService.GetDeviceVmsFromDeviceListAsync(data);
        _isBusy = false;
        StateHasChanged();

    }
}
